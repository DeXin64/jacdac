---
order: 7
title: Frames and Packets
---

# Frames

![An image depicting a JACDAC transmission. A JACDAC transmission begins with a start pulse of 11-14 us, a inter lo data spacing of minimally 40 us before data commences. A JACDAC transmission ends with an end pulse of 11-14 us.](./images/jacdac-activity.png)

The previous sections have discussed line signalling of a frame but there has been little discussion around how the data portion of a frame is organised.

The data portion of a JACDAC frame has the following layout in memory:

```c
struct _jd_frame_t {
    uint16_t frame_crc;
    uint8_t frame_size;
    uint8_t frame_flags;
    uint64_t device_identifier;
    uint8_t data[240]; // maximum
} __attribute__((__packed__, aligned(4)));
typedef struct _jd_frame_t jd_frame_t;
```

On the wire, the frame must be transmitted in little endian format (i.e. low byte of `frame_crc` first). The total maximum frame size is 252 bytes, selected to keep the total size of packet under `255` (the DMA limit on some hardware)and aligned to 4. The following table defines the meaning and size of the fields in the structure above.

| Memory offset | Field size (bytes) 	| Field name 	| Description  	|
|--------|------------	|-------------	|----------	|
| 0 | 2          	|`frame_crc`	| [16-bit CRC CCITT](https://en.wikipedia.org/wiki/Cyclic_redundancy_check) of all following fields. |
| 2 | 1          	|`frame_size`	| Size of the data field.	|
| 3 | 1          	|`frame_flags`	| Flags specific to this frame.	|
| 4 | 8          	|`device_identifier`	| 64-bit device identifier.	|
| 12 | 1 * frame_size   	|`data`	| The data payload of the frame.	|

## Frame flags

The `frame_flags` field is used to indicate

| Bit position | Bit name 	| Description 	|
|--------|------------	|-------------
| 0 | COMMAND	| Determines if the frame contains command or report packets. If set, the frame contains command packets, if not set, the frame contains report packets. 	|
| 1 | ACK_REQUESTED	| Determines if the receiver should return an ACK to the sender. If set, the receiver should repsond with an ACK frame, if not set, no response is required. 	|
| 2 | DEVICE_ID_ALT_MEANING	|  	|
| 3-7 | RESERVED	| Reserved for future use.	|

## Device identifiers

Each device is assigned a 64-bit device identifier that uniquely identifies it on the bus. This identifier is used in frames to determine the sending or receiving device, and for devices to remember one another on the bus. Device identifiers are generated, not allocated, and once generated a device's identifier must remain constant.

Device identifiers are not guaranteed to be universally unique, but there is little chance of users encountering identifier colision so long as identifiers are generated with appropriate entropy. We recommend the following ways of generating a unique identifier:

1. Use the random number generator embedded in this page to allocate an identifier for each device. The number generator could even be included into automated flashing processes to ensure appropriate entropy.

2. Use the random number generator embedded in this page to seed a hardware random number generator. The hardware random number generator could use sensor values to create further entropy.


# Packets

The data portion of a JACDAC frame is also structured and is internally divided into 1 or more packets. __Zero length frames are not supported__.

Each packet has the following layout in memory:

```c
struct _jd_packet_t {
    uint8_t packet_size;
    uint8_t service_instance;
    uint16_t service_command;
    uint8_t payload[236];
} __attribute__((__packed__, aligned(4)));
typedef struct _jd_packet_t jd_packet_t;
```

The following table defines the meaning and size of the fields in the structure above. The meaning of these fields will become clearer later on in this document.

| Memory offset | Field size (bytes) 	| Field name 	| Description  	|
|--------|------------	|-------------	|----------	|
| 12 | 1	|`packet_size`	| The size of the payload field. Maximum size is 236 bytes. |
| 13 | 1	|`service_instance`	| The instance number of the destination service.	|
| 14 | 2	|`service_command`	| A number that specifies an operation and code combination.	|
| 16 | 1 * packet_size	|`payload`	| The packet data payload destined for a particular service.	|

Packets are placed back-to-back inside the frame `data` field and must be padded so they start at a 4 byte boundary (i.e. `packet_size` is divisible by 4). Logically, packets placed in the same frame all share the same frame fields and thus the same `device_identifier`. This means only one device can be addressed in a single frame.